@using _20241129402SoruCevapPortali.Repositories
@inject IRepository<Category> CatRepo
@model List<_20241129402SoruCevapPortali.Models.Question>

@{
    ViewData["Title"] = "OyunForum Akışı";
    var users = ViewBag.Users as Dictionary<string, _20241129402SoruCevapPortali.Models.AppUser>;
}

<div class="row mb-3 align-items-center">
    <div class="col-md-6">
        <h1 class="text-danger fw-bold m-0"><i class="fas fa-gamepad"></i> OyunForum</h1>
        <p class="text-muted small m-0">Topluluğun nabzını tut, tartışmalara katıl.</p>
    </div>
    <div class="col-md-6 text-md-end mt-3 mt-md-0">
        @if (User.Identity.IsAuthenticated)
        {
            <a href="/Home/CreateQuestion" class="btn btn-danger fw-bold rounded-pill px-4 shadow-sm">
                <i class="fas fa-plus"></i> Yeni Konu Aç
            </a>
        }
    </div>
</div>

<div class="card bg-dark border-secondary mb-4 shadow-sm">
    <div class="card-body p-3">
        <form action="/Home/Index" method="get">
            <div class="row g-2">

                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text bg-secondary border-secondary text-white"><i class="fas fa-search"></i></span>
                        <input type="text" name="search" class="form-control bg-black text-white border-secondary" placeholder="Konu başlığı veya içerik ara..." value="@ViewBag.CurrentSearch">
                    </div>
                </div>

                <div class="col-md-3">
                    <select name="categoryId" class="form-select bg-black text-white border-secondary">
                        <option value="">Tüm Kategoriler</option>
                        @foreach (var item in (SelectList)ViewBag.Categories)
                        {
                            if (ViewBag.CurrentCategory != null && item.Value == ViewBag.CurrentCategory.ToString())
                            {
                                <option value="@item.Value" selected>@item.Text</option>
                            }
                            else
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <select name="sortOrder" class="form-select bg-black text-white border-secondary">
                        <!option value="" @(ViewBag.CurrentSort == null ? "selected" : "")>📅 En Yeniler</!option>
                        <!option value="date_asc" @(ViewBag.CurrentSort == "date_asc" ? "selected" : "")>📅 En Eskiler</!option>
                        <!option value="likes" @(ViewBag.CurrentSort == "likes" ? "selected" : "")>❤️ En Beğenilenler</!option>
                        <!option value="alpha" @(ViewBag.CurrentSort == "alpha" ? "selected" : "")>abc İsim Sırası (A-Z)</!option>
                    </select>
                </div>

                <div class="col-md-1">
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-12">
        @if (Model.Count == 0)
        {
            <div class="alert alert-dark text-center border-secondary text-muted">
                <i class="fas fa-ghost fa-2x mb-2"></i><br>
                Aradığınız kriterlere uygun konu bulunamadı.
            </div>
        }

        @foreach (var item in Model)
        {
            var category = CatRepo.GetById(item.CategoryId);
            var user = (users != null && users.ContainsKey(item.UserId)) ? users[item.UserId] : null;
            string yazarAdi = user?.UserName ?? "Gizli Üye";
            string yazarResmi = user?.PhotoUrl ?? "/img/undraw_profile.svg";
            string yazarRozet = user?.Badge ?? "Çaylak";
            int yazarLevel = user?.Level ?? 1;

            <div class="card mb-3 bg-dark border-secondary shadow forum-card position-relative" style="transition: transform 0.2s;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">

                        <div>
                            <span class="badge bg-danger mb-2">@category?.Name</span>
                            <span class="text-muted small ms-2"><i class="far fa-clock"></i> @item.CreatedDate.ToString("dd MMM HH:mm")</span>

                            <h5 class="card-title mb-1">
                                <a href="/Home/Details/@item.Id" class="text-decoration-none text-white fw-bold stretched-link">@item.Title</a>
                            </h5>

                            <p class="card-text text-white-50 text-truncate" style="max-width: 700px;">@item.Content</p>
                        </div>

                        <div class="text-end d-none d-md-block" style="z-index: 2; position:relative; min-width: 140px;">

                            <div class="d-flex align-items-center justify-content-end mb-2">
                                <div class="me-2 text-end">
                                    <div class="text-warning fw-bold small">@yazarAdi</div>
                                    <span class="badge bg-secondary text-white" style="font-size: 0.65rem;">
                                        @yazarRozet (Lvl @yazarLevel)
                                    </span>
                                </div>
                                <img src="@yazarResmi" class="rounded-circle border border-secondary" width="45" height="45" style="object-fit: cover;" alt="User">
                            </div>

                            <div class="btn btn-sm btn-dark border-secondary disabled text-white w-100" style="opacity:1;">
                                <i class="fas fa-heart text-danger"></i> @item.LikeCount Beğeni
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .forum-card:hover {
        border-color: #d90429 !important;
        transform: translateX(5px);
    }
</style>